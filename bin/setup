#!/usr/bin/env bash
# setup - 一键配置 claudex 别名

set -euo pipefail

# 配置
GOVERNANCE_DIR="$HOME/Documents/dev/cc rules/claude-governance"

# 颜色
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[✓]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[!]${NC} $*"; }

echo "================================================"
echo "  Claude Governance - 一键配置"
echo "================================================"
echo ""

# 检测 shell
if [[ -n "${BASH_VERSION:-}" ]]; then
    SHELL_TYPE="bash"
    RC_FILE="$HOME/.bashrc"
elif [[ -n "${ZSH_VERSION:-}" ]]; then
    SHELL_TYPE="zsh"
    RC_FILE="$HOME/.zshrc"
else
    log_warn "无法检测 shell 类型，请手动配置"
    exit 1
fi

log_info "检测到 Shell: $SHELL_TYPE"
log_info "配置文件: $RC_FILE"
echo ""

# 检查是否已配置
if grep -q "alias claudex=" "$RC_FILE" 2>/dev/null; then
    log_warn "已存在 claudex 别名配置"
    read -p "是否覆盖？[y/N]: " overwrite
    if [[ ! "$overwrite" =~ ^[Yy]$ ]]; then
        log_info "跳过配置"
        exit 0
    fi

    # 删除旧配置
    sed -i.bak '/alias claudex=/d' "$RC_FILE"
    sed -i.bak '/alias update-rules=/d' "$RC_FILE"
fi

# 添加别名
log_info "添加别名到 $RC_FILE..."

cat >> "$RC_FILE" <<EOF

# Claude Code Governance Aliases
alias claudex='$GOVERNANCE_DIR/bin/claudex'
alias update-rules='$GOVERNANCE_DIR/bin/update-rules'
EOF

log_success "别名已添加！"
echo ""

# 显示配置内容
log_info "已配置的别名："
echo "  claudex        - 启动 Claude Code（自动加载规则）"
echo "  update-rules   - 快速提交规则变更"
echo ""

# 提示重新加载
log_warn "请运行以下命令使配置生效："
echo ""
echo "  source $RC_FILE"
echo ""

log_info "或者关闭终端重新打开"
echo ""

log_success "配置完成！"
echo ""
echo "试试运行: claudex"
