#!/usr/bin/env bash
# update-rules - 快速更新并提交规则到 Git

set -euo pipefail

# 配置
GOVERNANCE_DIR="$HOME/Documents/dev/cc rules/claude-governance"

# 颜色
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[✓]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[!]${NC} $*"; }
log_error() { echo -e "${RED}[✗]${NC} $*"; }

# 切换到仓库目录
cd "$GOVERNANCE_DIR" || {
    log_error "无法进入目录: $GOVERNANCE_DIR"
    exit 1
}

echo "================================================"
echo "  Claude Governance - 规则更新工具"
echo "================================================"
echo ""

# 1. 检查 Git 状态
log_info "检查 Git 状态..."
if ! git status &>/dev/null; then
    log_error "当前目录不是 Git 仓库"
    exit 1
fi

# 2. 显示变更文件
log_info "检测到以下变更："
echo ""
git status --short
echo ""

# 3. 确认是否有变更
if [[ -z $(git status --porcelain) ]]; then
    log_warn "没有检测到任何变更"
    exit 0
fi

# 4. 询问提交信息
echo -e "${BLUE}请输入变更类型：${NC}"
echo "  1. feat    - 新增功能/规则"
echo "  2. fix     - 修复问题"
echo "  3. docs    - 文档更新"
echo "  4. refactor - 重构规则"
echo "  5. chore   - 其他变更"
echo ""
read -p "选择类型 [1-5]: " commit_type_choice

case $commit_type_choice in
    1) commit_type="feat" ;;
    2) commit_type="fix" ;;
    3) commit_type="docs" ;;
    4) commit_type="refactor" ;;
    5) commit_type="chore" ;;
    *) commit_type="chore" ;;
esac

# 5. 询问提交范围
echo ""
read -p "变更范围（如 rules/skills/mcp，留空跳过）: " commit_scope

# 6. 询问提交描述
echo ""
read -p "变更描述（简短说明）: " commit_message

if [[ -z "$commit_message" ]]; then
    log_error "提交描述不能为空"
    exit 1
fi

# 7. 构建完整的 commit message
if [[ -n "$commit_scope" ]]; then
    full_commit_message="${commit_type}(${commit_scope}): ${commit_message}"
else
    full_commit_message="${commit_type}: ${commit_message}"
fi

# 8. 显示预览
echo ""
log_info "提交预览："
echo "  消息: $full_commit_message"
echo "  变更文件:"
git status --short | sed 's/^/    /'
echo ""

# 9. 确认提交
read -p "确认提交？[Y/n]: " confirm
confirm=${confirm:-Y}

if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    log_warn "已取消提交"
    exit 0
fi

# 10. 执行 Git 操作
log_info "添加文件到暂存区..."
git add .

log_info "创建提交..."
git commit -m "$full_commit_message"

log_success "提交成功！"
echo ""

# 11. 询问是否推送
read -p "是否推送到 GitHub？[Y/n]: " push_confirm
push_confirm=${push_confirm:-Y}

if [[ "$push_confirm" =~ ^[Yy]$ ]]; then
    log_info "推送到远程仓库..."

    if git push origin main; then
        log_success "推送成功！"
        echo ""
        echo "查看仓库: https://github.com/Adrian-share/claude-governance"
    else
        log_error "推送失败，请检查网络或权限"
        log_info "稍后可以手动推送: git push origin main"
    fi
else
    log_warn "跳过推送"
    log_info "稍后可以手动推送: cd $GOVERNANCE_DIR && git push origin main"
fi

echo ""
log_success "完成！"
